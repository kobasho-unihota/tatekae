<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>立て替え入力</title>
<meta name="theme-color" content="#f6f4ef" />

<style>
:root{
  --bg:#f6f4ef;
  --card:#ffffffee;
  --text:#2b2b2b;
  --muted:#6b6b6b;
  --line:#e7e1d8;
  --accent:#3b7c6a;
  --good:#2f855a;
  --bad:#c53030;
  --radius:18px;
  --pad:18px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif;
  background:var(--bg);
  color:var(--text);
}
.wrap{
  max-width:520px;
  margin:auto;
  padding:20px 16px 40px;
}
h1{
  margin:0 0 6px;
  font-size:20px;
  font-weight:800;
}
p{
  margin:0 0 16px;
  font-size:13px;
  color:var(--muted);
}

.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:var(--pad);
}

label{
  font-size:12px;
  color:var(--muted);
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:12px;
}
input{
  min-height:48px;
  border-radius:14px;
  border:1px solid var(--line);
  padding:10px 12px;
  font-size:16px;
}
input:focus{
  outline:none;
  border-color:var(--accent);
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

button{
  width:100%;
  min-height:54px;
  border:none;
  border-radius:16px;
  background:var(--accent);
  color:#fff;
  font-size:16px;
  font-weight:800;
  margin-top:8px;
}
button:disabled{opacity:.6;}

.toast{
  display:none;
  margin-bottom:12px;
  padding:12px 14px;
  border-radius:14px;
  font-size:13px;
}
.toast.ok{background:#edf7f2;color:var(--good);}
.toast.ng{background:#fdecec;color:var(--bad);}
.toast.show{display:block;}

.history{
  margin-top:16px;
  border-top:1px solid var(--line);
  padding-top:12px;
}
.item{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  padding:8px 0;
}
.item .status{
  color:var(--muted);
}
</style>
</head>

<body>
<div class="wrap">

  <h1>立て替え入力</h1>
  <p>使った分だけ入力して送信してください。</p>

  <div id="toast" class="toast"></div>

  <div class="card">
    <form id="form">
      <div class="grid">
        <label>
          日付
          <input id="date" type="date" required />
        </label>
        <label>
          金額（円）
          <input id="amount" type="number" min="1" step="1" placeholder="850" required />
        </label>
      </div>

      <label>
        内容
        <input id="desc" type="text" placeholder="ランチ" required />
      </label>

      <button id="submit" type="submit">送信</button>
    </form>

    <div class="history">
      <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">
        このiPhoneの送信履歴
      </div>
      <div id="list"></div>
    </div>
  </div>
</div>

<script>
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxJkPn6ubLm5b87TEHZWB3BuM8ndTia1s8X5y91CwWlbQ8M85nrAjQdbfUrREs175rS/exec";
const LS_PASS = "tatekai_passcode_v2";
const LS_HISTORY = "tatekai_history_v2";

const $ = id => document.getElementById(id);
const toast = $("toast");
const list = $("list");

function showToast(type,msg){
  toast.className = "toast show " + type;
  toast.textContent = msg;
}

function today(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}

function loadHistory(){
  try{return JSON.parse(localStorage.getItem(LS_HISTORY)||"[]")}catch{return[]}
}
function saveHistory(arr){
  localStorage.setItem(LS_HISTORY,JSON.stringify(arr.slice(0,10)));
}
function renderHistory(){
  list.innerHTML="";
  loadHistory().forEach(h=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`<div>${h.date} / ${h.desc}</div><div class="status">${h.status}</div>`;
    list.appendChild(d);
  });
}

$("date").value=today();
renderHistory();

$("form").addEventListener("submit",async e=>{
  e.preventDefault();
  toast.className="toast";

  const payload={
    passcode:localStorage.getItem(LS_PASS)||"",
    date:$("date").value,
    amount:$("amount").value,
    desc:$("desc").value.trim()
  };

  const params=new URLSearchParams(payload);

  try{
    const res=await fetch(GAS_ENDPOINT,{method:"POST",body:params});
    const txt=await res.text();
    const data=JSON.parse(txt);

    if(data.ok){
      showToast("ok","送信しました");
      const h=loadHistory();
      h.unshift({...payload,status:"送信済み"});
      saveHistory(h);
      renderHistory();
      $("amount").value="";
      $("desc").value="";
      return;
    }
    showToast("ng","送信できませんでした");
  }catch{
    showToast("ng","通信できませんでした");
  }
});
</script>
</body>
</html>
