<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ç«‹æ›¿å…¥åŠ›</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 18px; }
    .card { border: 1px solid #ddd; border-radius: 16px; padding: 16px; }
    label { display:block; margin-top: 12px; font-size: 14px; }
    input, textarea, button { width: 100%; font-size: 18px; padding: 12px; border-radius: 12px; border: 1px solid #ccc; box-sizing: border-box; }
    button { margin-top: 14px; font-weight: 700; }
    .row { display:flex; gap: 10px; }
    .row > div { flex: 1; }
    .status { margin-top: 12px; font-size: 14px; white-space: pre-wrap; }
    .muted { color: #666; font-size: 12px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 8px;">ç«‹æ›¿å…¥åŠ›</h2>

    <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
    <input id="amount" inputmode="numeric" pattern="[0-9]*" placeholder="ä¾‹ï¼š850" />

    <label>å†…å®¹ï¼ˆåº—å/ç”¨é€”ï¼‰</label>
    <textarea id="desc" rows="2" placeholder="ä¾‹ï¼šãƒ©ãƒ³ãƒ / ã‚«ãƒ•ã‚§ / ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢"></textarea>

    <div class="row">
      <div>
        <label>æ—¥ä»˜</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>æ”¯æ‰•ï¼ˆä»»æ„ï¼‰</label>
        <input id="pay" placeholder="ä¾‹ï¼šç¾é‡‘ / PayPay" />
      </div>
    </div>

    <button id="send" type="button">é€ä¿¡</button>
    <div class="status" id="status"></div>
    <div class="muted" id="debug"></div>
  </div>

<script>
  // â˜…ã“ã“ã‚’GASã®Webã‚¢ãƒ—ãƒªURLï¼ˆ/execï¼‰ã«å·®ã—æ›¿ãˆ
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxJkPn6ubLm5b87TEHZWB3BuM8ndTia1s8X5y91CwWlbQ8M85nrAjQdbfUrREs175rS/exec";

  const $ = (id) => document.getElementById(id);

  // ä»Šæ—¥ã‚’åˆæœŸå€¤ã«
  (function initDate(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    $("date").value = `${yyyy}-${mm}-${dd}`;
  })();

  function setStatus(msg){ $("status").textContent = msg || ""; }
  function setDebug(msg){ $("debug").textContent = msg || ""; }

  function getPasscode(){
    let p = localStorage.getItem("tatekai_passcode");
    if(!p){
      p = prompt("åˆå›ã ã‘ï¼šåˆè¨€è‘‰ï¼ˆãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ï¼‰ã‚’å…¥åŠ›ã—ã¦ã­");
      if(p) localStorage.setItem("tatekai_passcode", p);
    }
    return p;
  }

  async function send(){
    // ã‚¯ãƒªãƒƒã‚¯åå¿œã®å¯è¦–åŒ–
    setStatus("å…¥åŠ›ãƒã‚§ãƒƒã‚¯ä¸­â€¦");

    const amountRaw = $("amount").value.trim();
    const desc = $("desc").value.trim();
    const date = $("date").value;
    const pay  = $("pay").value.trim();

    if(!amountRaw || !desc || !date){
      setStatus("é‡‘é¡ãƒ»å†…å®¹ãƒ»æ—¥ä»˜ã¯å¿…é ˆã ã‚ˆ");
      return;
    }

    const amount = Number(amountRaw);
    if(!Number.isFinite(amount) || amount <= 0){
      setStatus("é‡‘é¡ãŒä¸æ­£ã ã‚ˆï¼ˆæ•°å­—ã ã‘å…¥åŠ›ã—ã¦ã­ï¼‰");
      return;
    }

    const passcode = getPasscode();
    if(!passcode){
      setStatus("åˆè¨€è‘‰ãŒæœªè¨­å®šã ã‚ˆ");
      return;
    }

    const params = new URLSearchParams();
    params.append("amount", String(amount));
    params.append("date", date);
    params.append("desc", desc);
    params.append("pay", pay || "");
    params.append("passcode", passcode);

    try{
      $("send").disabled = true;
      setStatus("é€ä¿¡ä¸­â€¦");
      setDebug(`POST: ${GAS_ENDPOINT}`);

      const res = await fetch(GAS_ENDPOINT, { method: "POST", body: params });
      const text = await res.text();

      let json;
      try { json = JSON.parse(text); }
      catch { json = { ok:false, error:"non_json", detail:text, http_status: res.status }; }

      if(json.ok){
        setStatus("ç™»éŒ²ã—ãŸã‚ˆ âœ…");
        $("amount").value = "";
        $("desc").value = "";
        $("pay").value  = "";
      }else{
        if(json.error === "zaim_not_authorized" && json.auth_url){
          setStatus("åˆå›èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ä¸‹ã®URLã‚’é–‹ã„ã¦èªè¨¼ã—ã¦ã­ğŸ‘‡\n" + json.auth_url);
        }else{
          setStatus("å¤±æ•—ï¼š" + (json.error || "unknown") + "\n" + (json.detail || ""));
        }
      }
    }catch(e){
      setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼š" + e.message);
    }finally{
      $("send").disabled = false;
    }
  }

  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç¢ºå®Ÿã«ç™ºç«ã•ã›ã‚‹ï¼‰
  $("send").addEventListener("click", send);

  // ã€Œä½•ã‚‚åå¿œã—ãªã„ã€å¯¾ç­–ï¼šJSãŒå‹•ã„ã¦ã‚‹ã‹ã®å°
  setDebug("ready");
</script>
</body>
</html>
